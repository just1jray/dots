---
# Kubernetes tools configuration role
# Installs kubectl, helm, k9s, kubectx, and other k8s tools

- name: Install Kubernetes tools via Homebrew (macOS)
  community.general.homebrew:
    name: "{{ kubernetes_homebrew_packages }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Install kubectl (Linux)
  block:
    - name: Download kubectl binary
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version | default('stable') }}/bin/linux/{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
      become: yes
      when: kubectl_version is defined

    - name: Download latest stable kubectl
      shell: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
      args:
        creates: /usr/local/bin/kubectl
      when: kubectl_version is not defined
  when: ansible_os_family != "Darwin"

- name: Install Helm (Linux)
  block:
    - name: Download Helm installer
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Install Helm
      command: /tmp/get_helm.sh
      become: yes
      args:
        creates: /usr/local/bin/helm

    - name: Remove Helm installer
      file:
        path: /tmp/get_helm.sh
        state: absent
  when: ansible_os_family != "Darwin"

- name: Install k9s (Linux)
  block:
    - name: Get latest k9s version
      uri:
        url: https://api.github.com/repos/derailed/k9s/releases/latest
        return_content: yes
      register: k9s_latest

    - name: Download and install k9s
      unarchive:
        src: "https://github.com/derailed/k9s/releases/download/{{ k9s_latest.json.tag_name }}/k9s_Linux_{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}.tar.gz"
        dest: /tmp/
        remote_src: yes

    - name: Move k9s to bin
      command: mv /tmp/k9s /usr/local/bin/k9s
      become: yes
      args:
        creates: /usr/local/bin/k9s

    - name: Set k9s permissions
      file:
        path: /usr/local/bin/k9s
        mode: '0755'
      become: yes
  when: ansible_os_family != "Darwin"

- name: Create kubectl config directory
  file:
    path: "{{ ansible_env.HOME }}/.kube"
    state: directory
    mode: '0700'

- name: Enable kubectl autocompletion (zsh)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: "command -v kubectl &> /dev/null && source <(kubectl completion zsh)"
    create: yes
    mode: '0644'

- name: Create kubectl aliases file
  copy:
    content: |
      # Kubernetes aliases
      # Generated by Ansible

      # kubectl shortcuts
      alias k='kubectl'
      alias kgp='kubectl get pods'
      alias kgs='kubectl get svc'
      alias kgd='kubectl get deployments'
      alias kgn='kubectl get nodes'
      alias kdp='kubectl describe pod'
      alias kds='kubectl describe service'
      alias kdd='kubectl describe deployment'
      alias klf='kubectl logs -f'
      alias kaf='kubectl apply -f'
      alias kdel='kubectl delete'
      alias kex='kubectl exec -it'

      # kubectx/kubens shortcuts (if installed)
      alias kx='kubectx'
      alias kn='kubens'

      # Common operations
      alias kgetall='kubectl get all --all-namespaces'
      alias kwatch='kubectl get pods --watch'
      alias ktop='kubectl top'

      # Helm shortcuts
      alias h='helm'
      alias hls='helm list'
      alias hi='helm install'
      alias hu='helm upgrade'
      alias hdel='helm delete'

      # k9s shortcut
      alias k9='k9s'
    dest: "{{ ansible_env.HOME }}/.config/zsh/k8s-aliases"
    mode: '0644'

- name: Source k8s aliases in zshrc
  lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: "[[ -f $HOME/.config/zsh/k8s-aliases ]] && source $HOME/.config/zsh/k8s-aliases"
    create: yes
    mode: '0644'

- name: Create k9s config directory
  file:
    path: "{{ ansible_env.HOME }}/.config/k9s"
    state: directory
    mode: '0755'

- name: Display Kubernetes tools message
  debug:
    msg:
      - "âœ… Kubernetes tools installed!"
      - ""
      - "Tools available:"
      - "  kubectl - Kubernetes CLI"
      - "  helm - Kubernetes package manager"
      - "  k9s - Terminal UI for Kubernetes"
      - "  kubectx - Context switcher (macOS)"
      - "  kubens - Namespace switcher (macOS)"
      - "  stern - Multi-pod log tailing (macOS)"
      - ""
      - "Aliases configured in ~/.config/zsh/k8s-aliases:"
      - "  k, kgp, kgs, kgd, kgn - kubectl shortcuts"
      - "  h, hls, hi, hu - helm shortcuts"
      - "  k9 - launch k9s"
      - ""
      - "Connect to a cluster:"
      - "  # EKS (AWS)"
      - "  aws eks update-kubeconfig --name cluster-name --region us-east-1"
      - ""
      - "  # GKE (Google)"
      - "  gcloud container clusters get-credentials cluster-name --region us-central1"
      - ""
      - "  # Or manually add to ~/.kube/config"
      - ""
      - "Verify connection:"
      - "  kubectl cluster-info"
      - "  kubectl get nodes"
      - ""
      - "Launch k9s:"
      - "  k9s"
