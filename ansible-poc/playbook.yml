---
# Main playbook for dotfiles management
# Usage: ansible-playbook playbook.yml
# Dry run: ansible-playbook playbook.yml --check --diff
# With custom vars: ansible-playbook playbook.yml -e "git_user_name='John Doe'"

- name: Configure dotfiles and development environment
  hosts: localhost
  connection: local

  pre_tasks:
    - name: Display detected system information
      debug:
        msg:
          - "OS Family: {{ ansible_os_family }}"
          - "Distribution: {{ ansible_distribution | default('N/A') }}"
          - "Hostname: {{ ansible_hostname }}"
          - "User: {{ ansible_env.USER }}"
          - "Home: {{ ansible_env.HOME }}"
          - "Work machine: {{ is_work_machine }}"

    - name: Ensure required directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ ansible_env.HOME }}/Developer/src"
        - "{{ ansible_env.HOME }}/.config/zsh"
        - "{{ ansible_env.HOME }}/.tmux/plugins"
        - "{{ ansible_env.HOME }}/.tmux/resurrect"
        - "{{ ansible_env.HOME }}/Desktop/Screenshots"

  roles:
    # Install packages first (required for other roles)
    - role: homebrew
      when: ansible_os_family == "Darwin"
      tags: ['packages', 'homebrew']

    # Configure shell
    - role: zsh
      tags: ['dotfiles', 'zsh']

    # Configure version control
    - role: git
      tags: ['dotfiles', 'git']

    # Configure terminal multiplexer
    - role: tmux
      tags: ['dotfiles', 'tmux']

    # Configure editor
    - role: neovim
      tags: ['dotfiles', 'neovim', 'nvim']

    # Cloud & DevOps Tools
    # Install AWS CLI and tools
    - role: aws
      tags: ['cloud', 'aws', 'devops']

    # Install Google Cloud SDK
    - role: gcp
      tags: ['cloud', 'gcp', 'devops']

    # Install Kubernetes tools
    - role: kubernetes
      tags: ['cloud', 'kubernetes', 'k8s', 'devops']

    # Configure macOS system settings (macOS only)
    - role: macos
      when: ansible_os_family == "Darwin"
      tags: ['macos', 'settings']

  post_tasks:
    - name: Display completion message
      debug:
        msg:
          - "âœ… Dotfiles and development environment configuration complete!"
          - ""
          - "Next steps:"
          - "  1. Restart your terminal"
          - "  2. Open tmux and press 'prefix + I' to install plugins"
          - "  3. Open nvim - plugins will install automatically"
          - "  4. Configure cloud credentials if installed:"
          - "     - AWS: aws configure"
          - "     - GCP: gcloud init"
          - "     - Kubernetes: Add cluster config to ~/.kube/config"
          - ""
          - "Useful commands:"
          - "  ansible-playbook playbook.yml --tags zsh        # Only update zsh"
          - "  ansible-playbook playbook.yml --tags cloud      # Only cloud tools"
          - "  ansible-playbook playbook.yml --tags aws        # Only AWS tools"
          - "  ansible-playbook playbook.yml --check --diff    # Preview changes"
          - ""
          - "Documentation:"
          - "  See CLOUD_SKILLS.md for cloud tools guide"
          - "  See README.md for full documentation"
