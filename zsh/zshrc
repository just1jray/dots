### Added by Zinit's installer
if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})â€¦%f"
    command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
        print -P "%F{33} %F{34}Installation successful.%f%b" || \
        print -P "%F{160} The clone has failed.%f%b"
fi

source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit
### End of Zinit's installer chunk

# Environment Setup
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR=$(command -v nvim >/dev/null && echo "nvim" || echo "vim")
[[ $EDITOR == "nvim" ]] && alias vim="nvim"
command -v codium &> /dev/null && alias code="codium"

# PATH is managed in .zshenv

# Set LS_COLORS for file type coloring
if command -v vivid &> /dev/null; then
    export LS_COLORS="$(vivid generate catppuccin-mocha)"
fi

# Load Custom Aliases
source ~/.config/zsh/aliases

# Allow aliases to work with sudo
alias sudo='sudo '

# Vi mode
bindkey -v
export KEYTIMEOUT=1  # Fast mode switching (10ms)

# Keybindings (set after vi mode to override defaults)
bindkey '^p' history-search-backward
bindkey '^n' history-search-forward
bindkey '^\[w' kill-region

# History Configuration
HISTSIZE=50000                      # Increased from 5000 for better history retention
HISTFILE=~/.zsh_history
SAVEHIST=$HISTSIZE
HISTDUP=erase
setopt appendhistory                # Append to history file, don't overwrite
setopt sharehistory                 # Share history between all sessions
setopt extended_history             # Record timestamp of command in HISTFILE
setopt hist_ignore_space            # Ignore commands that start with space
setopt hist_ignore_all_dups         # Delete old recorded entry if new entry is a duplicate
setopt hist_ignore_dups             # Don't record an entry that was just recorded again
setopt hist_save_no_dups            # Don't write duplicate entries in the history file
setopt hist_find_no_dups            # Don't display a line previously found
setopt hist_reduce_blanks           # Remove superfluous blanks before recording entry
setopt hist_verify                  # Don't execute immediately upon history expansion
setopt auto_cd                      # Auto cd to a directory without typing cd

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu no

# Load Custom Host Configurations
[[ -f "$HOME/.config/zsh/hosts" ]] && source "$HOME/.config/zsh/hosts" && alias hosts="cat $HOME/.config/zsh/hosts"

# ZSH Plugins
# Load fast-syntax-highlighting synchronously to avoid prompt issues
zinit light-mode for \
    atinit"zicompinit; zicdreplay" \
        zdharma-continuum/fast-syntax-highlighting

# Load other plugins with turbo mode for faster startup
zinit wait lucid light-mode for \
    atload"_zsh_autosuggest_start" \
        zsh-users/zsh-autosuggestions \
    blockf atpull'zinit creinstall -q .' \
        zsh-users/zsh-completions

# Platform-specific configurations
if [[ $(uname) == "Darwin" ]]; then
    [[ -f "$HOME/.config/zsh/profile-macos" ]] && source "$HOME/.config/zsh/profile-macos"
elif [[ $(uname) == "Linux" ]]; then
    [[ -f "$HOME/.config/zsh/profile-linux" ]] && source "$HOME/.config/zsh/profile-linux"
fi

# fzf
if command -v fzf &> /dev/null; then
    # Initialize fzf with error handling
    if ! eval "$(fzf --zsh 2>/dev/null)"; then
        echo "Warning: Failed to initialize fzf" >&2
    else
        # Catppuccin Mocha theme for fzf
        export FZF_DEFAULT_OPTS="--height=80% \
--color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8 \
--color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc \
--color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8"

        zinit light Aloxaf/fzf-tab

        # Configure fzf-tab with Catppuccin colors
        zstyle ':fzf-tab:*' fzf-flags --height=80% --color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8 --color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc --color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8
        zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
    fi
fi

# zoxide
if command -v zoxide &> /dev/null; then
    # Initialize zoxide with error handling
    if ! eval "$(zoxide init --cmd cd zsh 2>/dev/null)"; then
        echo "Warning: Failed to initialize zoxide" >&2
    else
        zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'
    fi
fi

# Add in snippets
zinit snippet OMZL::git.zsh
zinit snippet OMZP::git
zinit snippet OMZP::sudo
zinit snippet OMZP::docker
zinit snippet OMZP::aws
zinit snippet OMZP::kubectl
zinit snippet OMZP::kubectx
zinit snippet OMZP::command-not-found

# Development Environment Managers
# Note: PYENV_ROOT and PATH are set in .zshenv
if command -v pyenv &> /dev/null; then
    # Initialize pyenv with error handling
    if ! eval "$(pyenv init - 2>/dev/null)"; then
        echo "Warning: Failed to initialize pyenv" >&2
    fi
fi

if command -v nvm &> /dev/null; then
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"
fi

# TMUX Session Management
if command -v tmux &> /dev/null; then
    # Auto-start TMUX only in regular terminal
    # This function will be called after zsh initialization is complete
    _start_tmux_after_init() {
        # Only run this function once
        add-zsh-hook -d precmd _start_tmux_after_init

        # Only try to start tmux if we're not already in a tmux session
        # Skip auto-start if we're in an SSH session to prevent nesting
        if [[ -z "$TMUX" && -n "$PS1" && \
              -z "$SSH_CONNECTION" && \
              ! "$TERM" = *screen* && \
              ! "$TERM" = *tmux* && \
              "$TERM_PROGRAM" != "vscode" && \
              "$TERM_PROGRAM" != "cursor" ]]; then
            # Start tmux without producing output
            tmux new-session -A -s sesh >/dev/null 2>&1 || true
        fi
    }
    
    # Register the function to run after zsh initialization
    autoload -Uz add-zsh-hook
    add-zsh-hook precmd _start_tmux_after_init
fi

# Added by Windsurf (conditional to avoid hardcoded paths)
if [[ -d "$HOME/.codeium/windsurf/bin" ]]; then
    add_to_path "$HOME/.codeium/windsurf/bin"
fi

# Disable paste highlighting for cleaner pasting
zle_highlight=('paste:none')

# Increase function nesting limit for Starship vi mode integration
FUNCNEST=1000

# Initialize Starship prompt
if command -v starship &> /dev/null; then
    if ! eval "$(starship init zsh 2>/dev/null)"; then
        echo "Warning: Failed to initialize Starship prompt" >&2
    fi
fi
